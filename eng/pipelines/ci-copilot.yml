# Pipeline for running GitHub Copilot PR Reviewer Agent
# This pipeline installs the Copilot CLI and invokes the PR reviewer agent
# to conduct automated code reviews on pull requests.
#
# For more information, see:
# https://github.com/dotnet/maui/wiki/PR-Reviewer-Agent

trigger: none  # Manual trigger only

pr: none  # Not triggered by PRs

parameters:
  - name: PRNumber
    displayName: 'Pull Request Number'
    type: string
    default: ''

  - name: pool
    type: object
    default:
      name: Azure Pipelines
      vmImage: macOS-15

variables:
  - template: /eng/pipelines/common/variables.yml@self
  - name: Codeql.Enabled
    value: false
  - name: Codeql.SkipTaskAutoInjection
    value: true

stages:
  - stage: FinalizePR
    displayName: 'Finalize Pull Request'
    jobs:
      - job: FinalizeJob
        displayName: 'Finalize PR with Copilot'
        pool: ${{ parameters.pool }}
        timeoutInMinutes: 30
        steps:
          - checkout: self
            fetchDepth: 0
            persistCredentials: true

          - script: |
              echo "Installing Node.js 22..."
              brew install node@22
              brew link --overwrite node@22
              if ! node --version; then
                echo "##vso[task.logissue type=error]Failed to install Node.js"
                exit 1
              fi
              npm --version
              echo "Node.js installed successfully"
            displayName: 'Install Node.js'

          - script: |
              echo "Installing GitHub CLI..."
              brew install gh
              if ! gh --version; then
                echo "##vso[task.logissue type=error]Failed to install GitHub CLI"
                exit 1
              fi
              echo "GitHub CLI installed successfully"
            displayName: 'Install GitHub CLI'

          - script: |
              echo "Authenticating with GitHub CLI..."
              if [ -z "$(GH_CLI_TOKEN)" ]; then
                echo "##vso[task.logissue type=error]GH_CLI_TOKEN is not set. Please configure the pipeline variable."
                exit 1
              fi
              echo "$(GH_CLI_TOKEN)" | gh auth login --with-token
              if ! gh auth status; then
                echo "##vso[task.logissue type=error]GitHub CLI authentication failed"
                exit 1
              fi
            displayName: 'Authenticate GitHub CLI'
            env:
              GH_CLI_TOKEN: $(GH_CLI_TOKEN)

          - script: |
              echo "Installing GitHub Copilot CLI..."
              npm install -g @github/copilot
              if ! which copilot; then
                echo "##vso[task.logissue type=error]Failed to install GitHub Copilot CLI"
                exit 1
              fi
              echo "Copilot CLI installed successfully"
            displayName: 'Install GitHub Copilot CLI'

          - script: |
              echo "Fetching PR #${{ parameters.PRNumber }}..."
              if ! git fetch origin pull/${{ parameters.PRNumber }}/head:pr-${{ parameters.PRNumber }}; then
                echo "##vso[task.logissue type=error]Failed to fetch PR #${{ parameters.PRNumber }}. Check that the PR exists."
                exit 1
              fi
              git checkout pr-${{ parameters.PRNumber }}
              echo "Checked out PR branch successfully"
              git log -1 --oneline
            displayName: 'Checkout PR Branch'

          - script: |
              echo "Running pr-finalize skill..."
              
              # Create artifacts directory for Copilot outputs
              mkdir -p $(Build.ArtifactStagingDirectory)/finalize-logs
              
              # Invoke the pr-finalize skill using Copilot CLI
              set +e
              copilot -p "use a skill pr-finalize to check the description and title of this pr" --yolo 2>&1 | tee $(Build.ArtifactStagingDirectory)/finalize-logs/pr_finalize_output.md
              FINALIZE_EXIT_CODE=$?
              set -e
              
              echo "pr-finalize exit code: $FINALIZE_EXIT_CODE"
              
              if [ $FINALIZE_EXIT_CODE -ne 0 ]; then
                echo "##vso[task.logissue type=error]pr-finalize skill failed with code $FINALIZE_EXIT_CODE"
                echo "##vso[task.setvariable variable=FinalizeFailed]true"
              fi
            displayName: 'Run pr-finalize Skill'
            env:
              GITHUB_TOKEN: $(COPILOT_TOKEN)

          - script: |
              echo "Posting finalize comment..."
              
              # Create artifacts directory if not exists
              mkdir -p $(Build.ArtifactStagingDirectory)/finalize-logs
              
              # Use Copilot CLI to post a comment
              set +e
              copilot -p "now use a skill to post a comment" --yolo 2>&1 | tee $(Build.ArtifactStagingDirectory)/finalize-logs/post_comment_output.md
              COMMENT_EXIT_CODE=$?
              set -e
              
              echo "Post comment exit code: $COMMENT_EXIT_CODE"
              
              if [ $COMMENT_EXIT_CODE -ne 0 ]; then
                echo "##vso[task.logissue type=warning]Post comment skill exited with code $COMMENT_EXIT_CODE"
              fi
            displayName: 'Post Comment Using Skill'
            env:
              GITHUB_TOKEN: $(COPILOT_TOKEN)
            condition: succeeded()

          # Publish finalize logs
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Finalize Logs'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/finalize-logs'
              artifact: 'FinalizeLogs'
              publishLocation: 'pipeline'
            condition: succeededOrFailed()

          # Fail the stage if finalize failed
          - script: |
              if [ "$(FinalizeFailed)" = "true" ]; then
                echo "##vso[task.logissue type=error]PR finalization failed. Check FinalizeLogs artifact for details."
                exit 1
              fi
            displayName: 'Check Finalize Result'
            condition: succeededOrFailed()